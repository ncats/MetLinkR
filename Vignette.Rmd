---
title: MetLinkR Vignette
author: "Andrew Patt"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    self_contained: yes
    highlight: kate
    theme: yeti
    toc: yes
    fig_width: 9
    fig_height: 7
    code_folding: show
vignette: >
  %\VignetteIndexEntry{Running MetLinkR locally}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

This vignette showcases the functionality of the metLinkR R package, the code for which can be found at [our github site](https://github.com/andyptt21/metLinkR).

MetLinkR is a package designed to harmonize and align metabolite identifiers across multiple input studies. Outputs are arranged to provide a number of ways to explore alignment results that will meet the different needs of various users. MetLinkR uses [RefMet](https://www.metabolomicsworkbench.org/databases/refmet/index.php) and [RaMP-DB](https://rampdb.nih.gov/) for metabolite name standardization and synonym searching, respectively. It is a relatively simple package with just one exported function meant for the user. Because meta-analyses of metabolomic studies can include tens of studies with thousands of metabolites, metLinkR performs queries in parallel, which requires simple setup to take advantage of.

Next we showcase the use of the main function of the package, `harmonizeInputFiles()`. This step also requires the creation of a csv manifest that contains metadata regarding the supplied metabolite IDs. Lastly, we provide an overview of the outputs provided by a typical metLinkR run. 

## Setting up parallel computing

MetLinkR automatically performs parallel computations using the `parallel` and `doParallel` packages, but requires that the user supply the number of cores that can be reserved for the task. This can be done with the `detectCores()` function:

```{r}
require(parallel)
available_cores <- parallel::detectCores()
## For maximum speed, we reserve all cores minus one, so the machine can still perform some background tasks
n_cores <- available_cores - 1
```

## Building identifier manifest

Next we need to build a csv manifest to describe the metadata provided for our metabolite entities in our inputs. The example manifest for this vignette is as follows:

| FileNames                                                  | ShortFileName  | HMDB    | Metabolite_Name  | PubChem_CID | KEGG | LIPIDMAPS | chebi |
|------------------------------------------------------------|----------------|---------|------------------|-------------|------|-----------|-------|
| example_data/SamplefromCOMETS.csv                          | inputfile      | HMDB_ID | metabolite_name  | PUBCHEM     | NA   | NA        | NA    |
| example_data/2019_Metabolon_Metadata.csv                   | VickyFile      | HMDB    | BIOCHEMICAL.NAME | PUBCHEM     | NA   | NA        | NA    |
| example_data/Metabolon_Annotations_Serum_hmdbformatted.csv | JohnFile       | HMDB    | CHEMICAL_NAME    | PUBCHEM     | NA   | NA        | NA    |
| example_data/CSVModifiedBroadfilefromVicky20182019.csv     | broadfileVicky | HMDB_ID | Metabolite       | COMP_ID     | NA   | NA        | NA    |
| example_data/Broad_2022Aug_annotations.csv                 | broadfileEwy   | hmdbId  | name             | pubChemId   | NA   | NA        | NA    |

1. The first column, "FileNames" provides the pathname for each of the five supplied input datasets.
2. The second, "ShortFileName", is an arbitrary nickname provided by the user that will be used for graphics and other outputs.
3. The remaining six columns correspond to the different identifier types accepted by MetLinkR. These include common name, HMDB ID, PubChem ID, KEGG ID, LIPIDMAPS ID, and Chebi ID. The entries in these rows are the column name relating to that identifier type in the supplied file. Note that NAs are acceptable if that identifier type is not present in a particular input. Further note that there are no restrictions in terms of which identifiers must be supplied; an identifier type does not need to be present across all input files for it to be incorporated into the mappings.

MetLinkR performs an exhaustive search of all identifier types supplied, meaning that all supplied IDs are queried to ensure the highest possible mapping rate. ID types are prioritized for harmonization purposes in the following order, from highest to lowest:

1. HMDB
2. KEGG
3. LIPIDMAPS
4. Chebi
5. Common Name
6. PubChem

With the manifest created and our input data files properly organized, we're ready to run metLinkR.

## Running harmonization

The main exported function for metLinkR is `harmonizeInputSheets`, which takes four paramaters as input:

1. `inputcsv`: the file/pathname for the identifier manifest we constructed
2. `outputFileName`: the filename for the output mapping library. 
3. `long_mapping_library`: one of the main outputs of a metLinkR analysis is the mapping library, which contains the associations with metabolite species from each input file to a consensus name generated by RefMet. This Boolean parameter specifies if this library should be returned in long or wide format.
4. `n_cores`: the number of cores for parallelization

`harmonizeInputSheets` will keep you apprised of its progress as it runs, and provide some stats on the mapping rates to the console as well as run time. Don't worry about saving this information, it will also be present in the output files.

```{r}
metLinkR_output <- harmonizeInputSheets("HarmInputFiles.csv","mapping_library",TRUE,n_cores)
```

## Exploring outputs

MetLinkR creates a new subdirectory in the current working directory called "metLinkR_output" which the various outputs are written to. Make sure that that this new directory ends up in a memorable and desireable location.

MetLinkR creates four basic outputs:

1. **Mapping library**: As described above, the file that contains the mappings between the consensus metabolite species names, and the entries as they appear in the input files. Can be in either long or wide format.
2. **Annotated input files**: the input files are returned with an added column that contains the consensus name for the metabolite in that row.
3. **PDF report**: A report is generated that details the mapping rates by file, lists the identifier types that were used to achieve the mappings, and a breakdown of the [ClassyFire](https://jcheminf.biomedcentral.com/articles/10.1186/s13321-016-0174-y) chemical superclass mappings that were associated with the identified metabolites.
4. **Text log**: the text log contains information on runtime, date/time the run was generated, a copy of the identifer manifest, and R session info for the run.

For questions/support/bugfixes for metLinkR, please see our [github repository]((https://github.com/andyptt21/metLinkR)) or contact the author directly at <andrew.patt@nih.gov>.
